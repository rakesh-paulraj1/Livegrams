FROM node:20-bookworm-slim AS base

RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"

RUN corepack enable && corepack prepare pnpm@9.0.0 --activate

FROM base AS deps
WORKDIR /app

COPY pnpm-lock.yaml package.json pnpm-workspace.yaml turbo.json ./
COPY packages ./packages/
COPY apps/web ./apps/web
ARG DATABASE_URL="postgres://user:pass@localhost:5432/dummy"
ENV DATABASE_URL=$DATABASE_URL
RUN pnpm install --frozen-lockfile

RUN find /app -type f -name ".env*" -delete

RUN pnpm db:generate

RUN pnpm --filter @repo/db run build

FROM base AS builder
WORKDIR /app

ARG DATABASE_URL="postgres://user:pass@localhost:5432/dummy"
ARG GEMINI_API_KEY="dummy"
ARG GOOGLE_API_KEY="dummy"
ARG NEXTAUTH_SECRET="dummy-secret-for-build"
ARG NEXTAUTH_URL="http://localhost:3000"

ENV DATABASE_URL=$DATABASE_URL
ENV GEMINI_API_KEY=$GEMINI_API_KEY
ENV GOOGLE_API_KEY=$GOOGLE_API_KEY
ENV NEXTAUTH_SECRET=$NEXTAUTH_SECRET
ENV NEXTAUTH_URL=$NEXTAUTH_URL

ARG NEXT_PUBLIC_WS_URL="wss://app.livegrams.tech/socket"
ENV NEXT_PUBLIC_WS_URL=$NEXT_PUBLIC_WS_URL

COPY --from=deps /app ./

RUN pnpm run build:web

FROM node:20-bookworm-slim AS runner
WORKDIR /app

ENV NODE_ENV=production
ENV HOSTNAME="0.0.0.0"
ENV PORT=3000

RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /app/apps/web/.next/standalone ./
COPY --from=builder /app/apps/web/.next/static ./apps/web/.next/static
COPY --from=builder /app/apps/web/public ./apps/web/public


EXPOSE 3000

CMD ["node", "apps/web/server.js"]

